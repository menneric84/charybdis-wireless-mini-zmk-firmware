# Charybdis Wireless Mini ZMK Firmware

## Project Overview

ZMK firmware configuration for a **Charybdis wireless mini split keyboard** (4x6 + thumb cluster) with a **PMW3610 trackball** on the right half. Runs on **SuperMini NRF52840** boards (built using the `nice_nano_v2` ZMK target). Supports Bluetooth and USB dongle connectivity.

## Project Structure

```
config/                     # Main firmware configuration
  west.yml                  # West manifest (ZMK + PMW3610 driver deps)
  charybdis.conf            # Common settings (BLE, split, mouse, power)
  charybdis_left.conf       # Left half config
  charybdis_right.conf      # Right half config (trackball sensor)
  charybdis_pmw3610.dtsi    # PMW3610 SPI/GPIO hardware config
  charybdis_pointer.dtsi    # Input processor chain (scaling, scroll)
  charybdis-layouts.dtsi    # Physical layout definitions
  keymap/                   # Keymap definitions
    qwerty.keymap           # Primary QWERTY keymap
    colemak_dh.keymap       # Colemak DH variant
    behaviors.dtsi          # Custom hold-tap, tap-dance, mod-morph
    combos.dtsi             # Key combos (caps word, mouse clicks)
    macros.dtsi             # Macros (tmux, git, VS Code shortcuts)
boards/shields/
  charybdis_bt/             # Bluetooth shield (left/right halves)
  charybdis_dongle/         # USB dongle shield (central receiver)
scripts/
  generate_matrix.py        # CI build matrix generator
local-build/                # Docker-based local build system
extra-keymaps/              # Additional layouts (Canary, Focal, Graphite)
firmwares/                  # Built firmware output (.uf2/.bin)
keymap-drawer/              # SVG keymap visualizations
.github/workflows/
  build.yml                 # CI: build firmware for all shield/keymap combos
  draw_keymaps.yml          # CI: generate keymap SVG drawings
build.yaml                  # Build matrix definition (board, shields, formats, keymaps)
```

## Build System

- **Toolchain**: Zephyr RTOS + ZMK v0.3 + west build system
- **Board**: `nice_nano_v2`
- **CI**: GitHub Actions using `zmkfirmware/zmk-build-arm:stable` Docker image
- **Local builds**: Docker Compose in `local-build/` using `zmkfirmware/zmk-dev-arm:stable`
- **Build matrix**: Generated by `scripts/generate_matrix.py` from `build.yaml`
- **Formats**: bt (Bluetooth), dongle (USB central), reset (settings reset)
- **Output**: `.uf2` firmware files per shield/keymap combination

### Building locally

```bash
cd local-build
docker compose run --rm zmk-build
# Firmware output in firmwares/
```

## Hardware Configuration

| Component | Details |
|-----------|---------|
| MCU | nRF52840 (**SuperMini NRF52840**, built using `nice_nano_v2` ZMK board target) |
| Layout | 4x6 split + 8 thumb keys (44+ total) |
| Sensor | PMW3610 trackball (right half only) |
| Sensor SPI | SCK P0.8, MOSI/MISO P0.17, CS P0.20, IRQ P0.6 |
| Sensor CPI | 400 |
| Connectivity | BLE split or USB dongle (central) |

### SuperMini NRF52840 vs Nice Nano v2

The SuperMini is Pro Micro-compatible and all GPIO aliases map correctly, but has important differences that require config tuning:

| | SuperMini NRF52840 | Nice Nano v2 |
|---|---|---|
| ZMK board target | `nice_nano_v2` | `nice_nano_v2` |
| Standby current | ~1000 µA | ~20 µA |
| DC/DC converter | Clone (can be unstable) | Genuine |
| Power ramp speed | Slower | Faster |

**Applied workarounds** (see `config/charybdis.conf` and `config/charybdis_right.conf`):
- `CONFIG_BOARD_ENABLE_DCDC_HV=n` — disables the HV boost converter to prevent SPI voltage instability that corrupts PMW3610 initialization (`SOC_DCDC_NRF52X_HV` is the indirect symbol; `BOARD_ENABLE_DCDC_HV` is the correct user-configurable parent in Zephyr 3.5)
- `CONFIG_PMW3610_INIT_POWER_UP_EXTRA_DELAY_MS=1000` — increased from 300ms to give the SuperMini's slower power rail time to stabilize before the driver checks the sensor product ID
- `CONFIG_PMW3610_RUN_DOWNSHIFT_TIME_MS=3264` — set to the driver's maximum (Kconfig range `[13, 3264]` ms) to reduce REST mode cycling; higher values are clamped by the driver

## Layers

| # | Name | Purpose |
|---|------|---------|
| 0 | BASE | QWERTY with home-row mods |
| 1 | NUM | Numbers + F-keys (tap/hold morph) |
| 2 | NAV | Arrows, TMUX nav, mouse pointer |
| 3 | SYM | Symbols and punctuation |
| 4 | GAME | Gaming (no home-row mods) |
| 5 | EXTRAS | Shortcuts, functions, snippets |
| 6 | SLOW | Low-speed pointer (precision) |
| 7 | SCROLL | Scroll mode (XY-to-scroll) |

## Key Conventions

- **Home-row mods**: Side-aware balanced hold-tap (`ht_left`, `ht_right` in `behaviors.dtsi`)
- **Tap dances**: Used for escape, space, mouse clicks, backspace with layer switching
- **Mod-morphs**: F-key morphs (number tap, F-key with shift held)
- **Combos**: Defined in `combos.dtsi` (caps word, mouse clicks, layer swap)
- **Macros**: Defined in `macros.dtsi` (tmux, git, VS Code, utilities)

## External Dependencies

- **ZMK firmware**: `zmkfirmware/zmk` (v0.3 branch) via west manifest
- **PMW3610 driver**: `badjeff/zmk-pmw3610-driver` (main branch) via west manifest

## Common Tasks

- **Edit keymap**: Modify files in `config/keymap/` (`.keymap`, `behaviors.dtsi`, `combos.dtsi`, `macros.dtsi`)
- **Change trackball settings**: Edit `config/charybdis_right.conf` (CPI, rest states) and `config/charybdis_pmw3610.dtsi` (hardware pins)
- **Adjust pointer behavior**: Edit `config/charybdis_pointer.dtsi` (scaling, scroll mapping)
- **Add a new keymap layout**: Create `.keymap` in `config/keymap/`, it auto-discovers via `generate_matrix.py`
- **Change BLE/power settings**: Edit `config/charybdis.conf`
- **Modify shield hardware**: Edit overlays in `boards/shields/charybdis_bt/` or `charybdis_dongle/`

## Config File Syntax

- `.conf` files: Kconfig format (`CONFIG_KEY=value`)
- `.dtsi` / `.overlay` files: Devicetree syntax (nodes, properties, bindings)
- `.keymap` files: Devicetree-based ZMK keymap format (layers, bindings, sensors)
- `west.yml`: YAML manifest for west workspace dependencies
